<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>TextHighlighter Example</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <style>
            .highlight {
                background-color: yellow;
            }

            ::selection {
                background-color: yellow;
            }

            .confirm-btn {
                position: absolute;
                display: none;
                z-index: 1000;
            }

            .highlight-container {
                position: relative;
                display: block;
                width: 100%;
                margin: 10px 0;
            }

            .collapsed-title {
                display: none;
                cursor: pointer;
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
            }

            .btn-group {
                display: flex;
                align-items: center;
            }

            .btn-remove {
                margin-left: 10px;
            }

            @media (max-width: 768px) {
                .card-body {
                    display: none;
                }

                .btn-collapse {
                    display: none;
                }
            }
        </style>
    </head>

    <body>
        <div class="container mt-5">
            <h1>TextHighlighter Example</h1>
            <p>Select some text to highlight it.</p>
            <div id="content">
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque imperdiet libero eu neque
                    facilisis.</p>
                <p>Curabitur fringilla leo at neque scelerisque, a posuere libero vestibulum. Integer a auctor lacus.
                </p>
            </div>
            <button id="removeHighlights" class="btn btn-danger mt-3">Remove Highlights</button>
            <button id="confirmHighlight" class="btn btn-primary confirm-btn">Confirm Highlight</button>
        </div>

        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
        <script src="/back_end/js/TextHighlighter.min.js"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                var content = document.getElementById('content');
                var confirmButton = document.getElementById('confirmHighlight');
                var hltr = new TextHighlighter(content, {
                    color: 'yellow',
                    onBeforeHighlight: function (range) {
                        // Check if the range is inside a collapsible div
                        var parent = range.commonAncestorContainer;
                        while (parent) {
                            if (parent.classList && parent.classList.contains('collapse')) {
                                return false;
                            }
                            parent = parent.parentNode;
                        }
                        return window.confirm('Selected text: ' + range + '\nReally highlight?');
                    },
                    onAfterHighlight: function (range, highlights) {
                        window.alert('Created ' + highlights.length + ' highlight(s): ' + highlights.map(function (h) {
                            return '"' + h.innerText + '"';
                        }).join(', '));

                        highlights.forEach(function (highlight, index) {
                            // Create a collapsible section inside the highlighted text
                            var highlightContainer = document.createElement('div');
                            highlightContainer.classList.add('highlight-container', 'card');

                            var cardHeader = document.createElement('div');
                            cardHeader.classList.add('card-header');
                            cardHeader.innerHTML = `
                            <h5 class="mb-0">
                                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-${index}" aria-expanded="true">
                                    ${highlight.innerText.substring(0, 10)}...
                                </button>
                            </h5>
                        `;

                            var btnGroup = document.createElement('div');
                            btnGroup.classList.add('btn-group');

                            var removeButton = document.createElement('button');
                            removeButton.classList.add('btn', 'btn-danger', 'btn-sm', 'btn-remove');
                            removeButton.innerText = 'Remove';
                            removeButton.addEventListener('click', function () {
                                var cardBodyText = highlightContainer.querySelector('.card-body').textContent;
                                var textNode = document.createTextNode(cardBodyText);
                                highlightContainer.replaceWith(textNode);
                            });

                            var collapseButton = document.createElement('button');
                            collapseButton.classList.add('btn', 'btn-primary', 'btn-sm', 'btn-collapse');
                            collapseButton.innerText = '+';
                            collapseButton.setAttribute('data-toggle', 'collapse');
                            collapseButton.setAttribute('data-target', `#collapse-${index}`);

                            btnGroup.appendChild(collapseButton);
                            btnGroup.appendChild(removeButton);
                            cardHeader.appendChild(btnGroup);

                            var collapseSection = document.createElement('div');
                            collapseSection.classList.add('collapse');
                            collapseSection.id = `collapse-${index}`;
                            collapseSection.innerHTML = `<div class="card-body">${highlight.innerHTML}</div>`;

                            highlightContainer.appendChild(cardHeader);
                            highlightContainer.appendChild(collapseSection);

                            highlight.replaceWith(highlightContainer);
                        });
                    },
                    onRemoveHighlight: function (hl) {
                        return window.confirm('Do you really want to remove: "' + hl.innerText + '"');
                    }
                });

                confirmButton.addEventListener('click', function () {
                    // Highlight the stored range
                    if (hltr._pendingRange) {
                        hltr.doHighlight(hltr._pendingRange);
                        hltr._pendingRange = null;
                    }

                    // Hide the confirm button
                    confirmButton.style.display = 'none';
                });

                document.getElementById('removeHighlights').addEventListener('click', function () {
                    hltr.removeHighlights();
                });

                // Hide the confirm button if the user clicks outside the content
                document.addEventListener('click', function (event) {
                    if (!content.contains(event.target) && event.target !== confirmButton) {
                        confirmButton.style.display = 'none';
                    }
                });
            });
        </script>
    </body>

</html>